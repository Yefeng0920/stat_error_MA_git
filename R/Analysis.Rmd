---
title: "Untitled"
output: html_document
date: '2024-03-01'
---

# Packages

```{r, warning=FALSE, echo=TRUE}
set.seed(2024)
suppressPackageStartupMessages({
  library(dplyr)
  library(readr)
  library(tidyr) 
  library(ggplot2)
  library(metafor)
  library(here)
  library(RColorBrewer)
  library(clubSandwich)
  library(ggExtra)
  library(cowplot)
  library(patchwork)
  library(aplot)
  library(ggridges)
  library(ggplotify) 
  library(palettetown)
  library(wesanderson)
  library(ggpubr) 
  library(zcurve)
  })
```

# Function

```{r}
# power (two-tail) for meta-analysis
powerMA <- function(mu, SE, alpha = 0.05) {
  1 - pnorm(qnorm(1 - 0.05 / 2) - abs(mu) / SE) + pnorm(-qnorm(1 - 0.05 / 2)-abs(mu) / SE)
} 

# S error for meta-analysis
errorS <- function(mu, se, alpha = 0.05){
  p.u <- 1 - pnorm(qnorm(1 - alpha/2) - abs(mu)/se) 
  p.l <- pnorm(-qnorm(1 - alpha/2) - abs(mu)/se) 
  power <- p.u + p.l 
  errorS <- p.l/power 
  return(errorS)
} 

errorM <- function(mu, se, alpha = 0.05, N = 1e5) {
    est.random <- rnorm(n=N, mean = mu, sd = se)
    sig.index <- suppressWarnings(abs(est.random) > se*qnorm(1 - alpha/2))
    overestimate <- mean(abs(est.random)[sig.index])/abs(mu) 
    absolute_error <- overestimate*abs(mu) - abs(mu)
    relative_error <- absolute_error/(overestimate*abs(mu))
  return(abs(overestimate) %>% round(3))
}



# meta-analysis of magnitude
## folded effect size
folded_es <-function(mean, variance){ # the sampling variance of magnitude   
  mu <- mean
  sigma <- sqrt(variance)
  fold_mu <- sigma*sqrt(2/pi)*exp((-mu^2)/(2*sigma^2)) + mu*(1 - 2*pnorm(-mu/sigma))
  fold_mu
}
## folded error
folded_error <- function(mean, variance){ # the sampling variance of magnitude   
  mu <- mean
  sigma <- sqrt(variance)
  fold_mu <- sigma*sqrt(2/pi)*exp((-mu^2)/(2*sigma^2)) + mu*(1 - 2*pnorm(-mu/sigma))
  fold_se <- sqrt(mu^2 + sigma^2 - fold_mu^2)
  # adding se to make bigger mean
  fold_v <- fold_se^2
  fold_v
}

# functions for the mixture distribution
dmix = function(x,p,m,s){
  drop(p %*% sapply(x, function(x) dnorm(x,mean=m,sd=s)))
}

rmix = function(n,p,m,s){    # sample from a normal mixture
  d=rmultinom(n,1,p)
  rnorm(n,m%*%d,s%*%d)
}

pmix = function(x,p,m,s){ # cumulative distr (vector x)
  drop(p %*% sapply(x, function(x) pnorm(x,mean=m,sd=s)))
}

# Estimate k-component zero-mean normal mixture distribution
# The function accepts weights.
# The function also accepts censoring below c1 and above c2.
# Uses base R function `constrOptim` to run constrained optimization. 
# We define the log likelihood function and set up constraints such
# that the mixture proportions are non-negative and add up to 1, 
# and the component variances are at least 1.
mix = function(z,k=3,c1=0,c2=10^6,weights=1){
  # log likelihood function
  loglik = function(theta,z,k,weights=1){
    p=c(theta[1:(k-1)],1-sum(theta[1:(k-1)]))
    s=theta[k:(2*k-1)]
    m=rep(0,k)
    #lik=dmix(z,p,m=m,s=s)
    lik1=(abs(z) < c1)*(pmix(c1,p,m=m,s=s) - pmix(-c1,p,m=m,s=s))
    lik2=(abs(z) >= c1)*(abs(z) < c2)*dmix(z,p,m=m,s=s)
    lik3=(abs(z) >= c2)*(pmix(-c2,p,m=m,s=s) + 1 - pmix(c2,p,m=m,s=s))
    lik=lik1+lik2+lik3
    return(-sum(weights*log(lik)))   # *minus* the weighted log lik
  }
  # set up constraints for optimization
  # The feasible region is defined by ui %*% par - ci >= 0
  ui=c(rep(-1,(k-1)),rep(0,k))         # (k-1) mixture props sum to < 1
  ui=rbind(ui,cbind(diag(2*k-1)))
  ci=c(-1,rep(0,k-1),rep(1,k))
  
  # set starting value
  theta0=c(rep(1/k,(k-1)),c(1.2,2:k))
  opt=constrOptim(theta=theta0,f=loglik,ui=ui,ci=ci,
                  method = "Nelder-Mead",
                  z=z,weights=weights,k=k,
                  control=list(maxit=10^4))
  
  # collect the results
  p=c(opt$par[1:(k-1)],1-sum(opt$par[1:(k-1)]))  # mixture proportions
  sigma=opt$par[k:(2*k-1)]                       # mixture sds
  m=rep(0,k)                                     # mixture means
  df=data.frame(p=p,m=m,sigma=sigma)
  return(df)
}

# p(SNR | z) when snr ~ dmix(p,m,s)
posterior <- function(z,p,m,s) { 
  s2=s^2
  p=p*dnorm(z,m,sqrt(s2+1))
  p <- p/sum(p)         # conditional mixing probs
  pm <- z*s2/(s2+1) + m/(s2+1) # conditional means
  pv <- s2/(s2+1)          # conditional variances
  ps <- sqrt(pv)            # conditional std devs
  data.frame(p,pm,ps)
}

# probability of replication when snr ~ dmix(p,m,s)
# and we observed a particular z-stat in the original study
# and the replication study is "multiplier" times as large.
replcalc <- function(z,p,m,s,multiplier=1){
  post=posterior(abs(z),p=p,m=m,s=s)
  pp=post$p
  pm=sqrt(multiplier)*post$pm
  ps=sqrt(multiplier)*post$ps
  1 - pmix(1.96,p=pp,m=pm,s=sqrt(ps^2 + 1))
}

# remove the constrain on variance components
mix2 = function(z, k = 3, c1 = 0, c2 = 10^6, weights = 1){
  # log likelihood function
  loglik = function(theta, z, k, weights = 1){
    p = c(theta[1:(k-1)], 1 - sum(theta[1:(k-1)]))
    s = theta[k:(2*k-1)]
    m = rep(0, k)
    lik1 = (abs(z) < c1) * (pmix(c1, p, m = m, s = s) - pmix(-c1, p, m = m, s = s))
    lik2 = (abs(z) >= c1) * (abs(z) < c2) * dmix(z, p, m = m, s = s)
    lik3 = (abs(z) >= c2) * (pmix(-c2, p, m = m, s = s) + 1 - pmix(c2, p, m = m, s = s))
    lik = lik1 + lik2 + lik3
    return(-sum(weights * log(lik)))   # *minus* the weighted log lik
  }
  
  # set up constraints for optimization
  # The feasible region is defined by ui %*% par - ci >= 0
  ui = c(rep(-1, (k-1)), rep(0, k))         # (k-1) mixture props sum to < 1
  ui = rbind(ui, diag(2*k-1))
  ci = c(-1, rep(0, k-1), rep(0, k))        # Removed constraint about variances being at least 1
  
  # set starting value
  theta0 = c(rep(1/k, (k-1)), c(1.2, 2:k))
  opt = constrOptim(theta = theta0, f = loglik, ui = ui, ci = ci,
                    method = "Nelder-Mead",
                    z = z, weights = weights, k = k,
                    control = list(maxit = 10^4))
  
  # collect the results
  p = c(opt$par[1:(k-1)], 1 - sum(opt$par[1:(k-1)]))  # mixture proportions
  sigma = opt$par[k:(2*k-1)]                          # mixture sds
  m = rep(0, k)                                        # mixture means
  df = data.frame(p = p, m = m, sigma = sigma)
  return(df)
}

calcRodds <- function(FDR, pwr, alpha = 0.05) {
  R = alpha * (1 - FDR) / (pwr * FDR)
  Pr = R / (R + 1)
  return(Pr)
}

```


# Data

```{r}
# summary information about individual meta-analyses
studies_info <- readRDS(here("Dat", "studies_info.RDS"))
# model estimates
dat <- read.csv(here::here("Dat","est.csv"))
names(dat)[3:7] <- c("mu_adj", "se_adj", "mu_unadj", "se_unadj", "discipline") 
# statistical evidence
dat <- dat %>% mutate(z_adj = mu_adj / se_adj, z_unadj = mu_unadj / se_unadj)
```



# Error
```{r}
#saveRDS(dat, here("Dat","dat.rds"))
dat <- readRDS(here("Dat","dat.rds"))

# power
dat <- dat %>% mutate(pwr_unadj = powerMA(mu = mu_unadj, SE = se_unadj),
                      pwr_adj = powerMA(mu = mu_adj, SE = se_adj))
# M
M_unadj <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  M_unadj[i] <- errorM(mu = dat$mu_unadj[i], se = dat$se_unadj[i])
}
dat$M_unadj <- M_unadj

M_adj <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  M_adj[i] <- errorM(mu = dat$mu_adj[i], se = dat$se_adj[i])
}
dat$M_adj <- M_adj

# S
S_unadj <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  S_unadj[i] <- errorS(mu = dat$mu_unadj[i], se = dat$se_unadj[i])
}
dat$S_unadj <- S_unadj

S_adj <- numeric(nrow(dat))
for (i in 1:nrow(dat)) {
  S_adj[i] <- errorS(mu = dat$mu_adj[i], se = dat$se_adj[i])
}
dat$S_adj <- S_adj

```



# Mixture model

## Modelling1
```{r}
# overall
#mix.df <- mix(z=dat$z_adj,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df, here("Dat","mix.df.rds"))
mix.df <- readRDS(here("Dat","mix.df.rds"))
p <- mix.df$p
m <- mix.df$m
sigma <- mix.df$sigma

# economics
dat_eco <- dat %>% filter(discipline == "economics")
#mix.df_eco <- mix(z=dat_eco$z_adj,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_eco, here("Dat","mix.df_eco.rds"))
mix.df_eco <- readRDS(here("Dat","mix.df_eco.rds"))
p_eco <- mix.df_eco$p
m <- mix.df_eco$m
sigma_eco <- mix.df_eco$sigma

#mix.df_eco2 <- mix(z=dat_eco$z_unadj,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_eco2, here("Dat","mix.df_eco2.rds"))
mix.df_eco2 <- readRDS(here("Dat","mix.df_eco2.rds"))
p_eco2 <- mix.df_eco2$p
m <- mix.df_eco2$m
sigma_eco2 <- mix.df_eco2$sigma

# the absolute $z$-statistics together with the fitted mixture
df=data.frame(z=dat_eco$z_adj,dens=2*dmix(x=abs(dat_eco$z_adj),p=p_eco,m=m,s=sigma_eco)) 
ggplot(dat_eco, aes(x = abs(z_adj))) +
  geom_histogram(aes(y = after_stat(density)),
                 breaks=seq(0,20,0.5),fill = "white",color="black") +
  geom_line(data=df,aes(x=z,y=dens), alpha=1, linewidth = 0.8) +
  xlim(0,20) + 
  labs(x = expression(paste(italic(z)~"statistic")), y = "Density") +
  theme_bw()

# environment
dat_env <- dat %>% filter(discipline == "environmental")
#mix.df_env <- mix(z=dat_env$z_adj,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_env, here("Dat","mix.df_env.rds"))
mix.df_env <- readRDS(here("Dat","mix.df_env.rds"))
p_env <- mix.df_env$p
m <- mix.df_env$m
sigma_env <- mix.df_env$sigma

# medicine
dat_med <- dat %>% filter(discipline == "medicine")
#mix.df_med <- mix(z=dat_med$z_adj,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_med, here("Dat","mix.df_med.rds"))
mix.df_med <- readRDS(here("Dat","mix.df_med.rds"))
p_med <- mix.df_med$p
m <- mix.df_med$m
sigma_med <- mix.df_med$sigma

# psychology
dat_psy <- dat %>% filter(discipline == "psychology")
#mix.df_psy <- mix(z=dat_psy$z_adj,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_psy, here("Dat","mix.df_psy.rds"))
mix.df_psy <- readRDS(here("Dat","mix.df_psy.rds"))
p_psy <- mix.df_psy$p
m <- mix.df_psy$m
sigma_psy <- mix.df_psy$sigma
```

## Estimate1

```{r}
# overall
snr=rmix(10^7,p=p,m=m,s=sqrt(sigma^2 - 1))
# power
power=pnorm(-1.96,snr,1) + 1 - pnorm(1.96,snr,1)
# replication
z.orig=snr + rnorm(10^7) # original
z.repl = snr + rnorm(10^7) # replication
replicate=(z.orig * z.repl > 0) & (abs(z.repl) > 1.96)
mean(replicate)  #   0.1501245                # unconditional probability of replication
mean(replicate[abs(z.orig)>1.96]) # 0.5747267 # conditional probability of replication given |z|>1.96


# economics
snr_eco=rmix(10^7,p=p_eco,m=m,s=sqrt(sigma_eco^2 - 1))
# power
power_eco=pnorm(-1.96,snr_eco,1) + 1 - pnorm(1.96,snr_eco,1)
# replication
z.orig_eco=snr_eco + rnorm(10^7) # original
z.repl_eco = snr_eco + rnorm(10^7) # replication
replicate_eco=(z.orig_eco * z.repl_eco > 0) & (abs(z.repl_eco) > 1.96)
mean(replicate_eco)  #   0.4197378                # unconditional probability of replication
mean(replicate_eco[abs(z.orig_eco)>1.96]) # 0.774006 # conditional probability of replication given |z|>1.96


# environment
snr_env=rmix(10^7,p=p_env,m=m,s=sqrt(sigma_env^2 - 1))
# power
power_env=pnorm(-1.96,snr_env,1) + 1 - pnorm(1.96,snr_env,1)
# replication
z.orig_env=snr_env + rnorm(10^7) # original
z.repl_env = snr_env + rnorm(10^7) # replication
replicate_env=(z.orig_env * z.repl_env > 0) & (abs(z.repl_env) > 1.96)
mean(replicate_env)                    # unconditional probability of replication
mean(replicate_env[abs(z.orig_env)>1.96])  # conditional probability of replication given |z|>1.96

# medicine
snr_med=rmix(10^7,p=p_med,m=m,s=sqrt(sigma_med^2 - 1))
# power
power_med=pnorm(-1.96,snr_med,1) + 1 - pnorm(1.96,snr_med,1)
# replication
z.orig_med=snr_med + rnorm(10^7) # original
z.repl_med = snr_med + rnorm(10^7) # replication
replicate_med=(z.orig_med * z.repl_med > 0) & (abs(z.repl_med) > 1.96)
mean(replicate_med)                    # unconditional probability of replication
mean(replicate_med[abs(z.orig_med)>1.96])  # conditional probability of replication given |z|>1.96


# psychology
snr_psy=rmix(10^7,p=p_psy,m=m,s=sqrt(sigma_psy^2 - 1))
# power
power_psy=pnorm(-1.96,snr_psy,1) + 1 - pnorm(1.96,snr_psy,1)
# replication
z.orig_psy=snr_psy + rnorm(10^7) # original
z.repl_psy = snr_psy + rnorm(10^7) # replication
replicate_psy=(z.orig_psy * z.repl_psy > 0) & (abs(z.repl_psy) > 1.96)
mean(replicate_psy)                    # unconditional probability of replication
mean(replicate_psy[abs(z.orig_psy)>1.96])  # conditional probability of replication given |z|>1.96
```




```{r, echo=TRUE, warning=FALSE}
# typical p
pval=c(0.1,0.05,0.01,0.001,0.0001)
zval=qnorm(1 - pval/2)
strength = c("No evidence", "Weak evidence","Moderate evidence",
             "Strong evidence","Very strong evidence")
strength = factor(strength,
                  levels=c("No evidence", "Weak evidence",
                           "Moderate evidence","Strong evidence",
                           "Very strong evidence"))


# overall
replicate <- sapply(zval,replcalc,p=p,m=m,s=sqrt(sigma^2-1))
rep <- data.frame(strength,pval,zval,replicate)


# economics
replicate <- sapply(zval,replcalc,p=p_eco,m=m,s=sqrt(sigma_eco^2-1))
rep_eco <- data.frame(strength,pval,zval,replicate)

replicate2 <- sapply(zval,replcalc,p=p_eco2,m=m,s=sqrt(sigma_eco2^2-1))
rep_eco2 <- data.frame(strength,pval,zval,replicate2)

# environment
replicate <- sapply(zval,replcalc,p=p_env,m=m,s=sqrt(sigma_env^2-1))
rep_env <- data.frame(strength,pval,zval,replicate)
# medicine
replicate <- sapply(zval,replcalc,p=p_med,m=m,s=sqrt(sigma_med^2-1))
rep_med <- data.frame(strength,pval,zval,replicate)
# psychology
replicate <- sapply(zval,replcalc,p=p_psy,m=m,s=sqrt(sigma_psy^2-1))
rep_psy <- data.frame(strength,pval,zval,replicate)
```


# Figure1 - replicate

```{r}
zval <- sort(c(seq(1.96,6,by=0.1), 1.96, 2.58, 3.29, 3.89, 6))

# economics
replicate <- sapply(zval,replcalc,p=p_eco,m=m,s=sqrt(sigma_eco^2-1))
rep_eco <- data.frame(zval,replicate)
rep_eco <- rep_eco %>% mutate(strength = case_when( zval >= 1.64 & zval <= 1.96 ~ "Weak",
                                                    zval >= 1.96 & zval <= 2.58 ~ "Moderate",
                                                    zval >= 2.58 & zval <= 3.29 ~ "Strong",
                                                    zval >= 3.29 ~ "Very strong"))


rep.dist.eco <- ggplot(data = rep_eco, aes(x = zval, y = replicate)) +
  geom_line(linetype="solid", color="black", linewidth = 0.5) +
  geom_ribbon(data = filter(rep_eco, zval >= 1.96 & zval <= 2.58), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.2) +
  geom_ribbon(data = filter(rep_eco, zval >= 2.58 & zval <= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.4) +
  geom_ribbon(data = filter(rep_eco, zval >= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.5) + 
  geom_text(data = data.frame(x = c(2.27, 2.935, 4.645), 
                              label = c("Modest", "Strong", "Very Strong")),
            aes(x = x, y = 0.02, label = label), 
            vjust = 0, size = 3, color = "black", alpha = 0.7) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2),
                     minor_breaks=seq(0,1,0.05),expand = expansion(mult = c(0, 0.01)), labels = scales::percent_format(accuracy=1)) +
  scale_x_continuous(breaks = c(1.96,3,4,5,6), expand = expansion(mult = c(0.01, 0.01))) +
  ylab("Replicability") + xlab(expression(paste("Statistical evidence"~italic()))) +
  labs(colour = NULL, title = "Economics") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        #axis.text.x = element_blank(),
        #axis.ticks.x = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))



# environment
replicate <- sapply(zval,replcalc,p=p_env,m=m,s=sqrt(sigma_env^2-1))
rep_env <- data.frame(zval,replicate)
rep_env <- rep_env %>% mutate(strength = case_when( zval >= 1.64 & zval <= 1.96 ~ "Weak",
                                                    zval >= 1.96 & zval <= 2.58 ~ "Moderate",
                                                    zval >= 2.58 & zval <= 3.29 ~ "Strong",
                                                    zval >= 3.29 ~ "Very strong"))


rep.dist.env <- ggplot(data = rep_env, aes(x = zval, y = replicate)) +
  geom_line(linetype="solid", color="black", linewidth = 0.5) +
  geom_ribbon(data = filter(rep_env, zval >= 1.96 & zval <= 2.58), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.2) +
  geom_ribbon(data = filter(rep_env, zval >= 2.58 & zval <= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.4) +
  geom_ribbon(data = filter(rep_env, zval >= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.5) + 
  geom_text(data = data.frame(x = c(2.27, 2.935, 4.645), 
                              label = c("Modest", "Strong", "Very Strong")),
            aes(x = x, y = 0.02, label = label), 
            vjust = 0, size = 3, color = "black", alpha = 0.7) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2),
                     minor_breaks=seq(0,1,0.05),expand = expansion(mult = c(0, 0.01)), labels = scales::percent_format(accuracy=1)) +
  scale_x_continuous(breaks = c(1.96,3,4,5,6), expand = expansion(mult = c(0.01, 0.012))) +
  ylab("Replicability") + xlab(expression(paste("Statistical evidence"~italic()))) +
  labs(colour = NULL, title = "Environment") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        #axis.text.x = element_blank(),
        #axis.ticks.x = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))

# medicine
replicate <- sapply(zval,replcalc,p=p_med,m=m,s=sqrt(sigma_med^2-1))
rep_med <- data.frame(zval,replicate)
rep_med <- rep_med %>% mutate(strength = case_when( zval >= 1.64 & zval <= 1.96 ~ "Weak",
                                                    zval >= 1.96 & zval <= 2.58 ~ "Moderate",
                                                    zval >= 2.58 & zval <= 3.29 ~ "Strong",
                                                    zval >= 3.29 ~ "Very strong"))


rep.dist.med <- ggplot(data = rep_med, aes(x = zval, y = replicate)) +
  geom_line(linetype="solid", color="black", linewidth = 0.5) +
  geom_ribbon(data = filter(rep_med, zval >= 1.96 & zval <= 2.58), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.2) +
  geom_ribbon(data = filter(rep_med, zval >= 2.58 & zval <= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.4) +
  geom_ribbon(data = filter(rep_med, zval >= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.5) + 
  geom_text(data = data.frame(x = c(2.27, 2.935, 4.645), 
                              label = c("Modest", "Strong", "Very Strong")),
            aes(x = x, y = 0.02, label = label), 
            vjust = 0, size = 3, color = "black", alpha = 0.7) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2),
                     minor_breaks=seq(0,1,0.05),expand = expansion(mult = c(0, 0.01)), labels = scales::percent_format(accuracy=1)) +
  scale_x_continuous(breaks = c(1.96,3,4,5,6), expand = expansion(mult = c(0.01, 0.012))) +
  ylab("Replicability") + xlab(expression(paste("Statistical evidence"~italic()))) +
  labs(colour = NULL, title = "Medicine") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        #axis.text.x = element_blank(),
        #axis.ticks.x = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))


# psychology
replicate <- sapply(zval,replcalc,p=p_psy,m=m,s=sqrt(sigma_psy^2-1))
rep_psy <- data.frame(zval,replicate)
rep_psy <- rep_psy %>% mutate(strength = case_when( zval >= 1.64 & zval <= 1.96 ~ "Weak",
                                                    zval >= 1.96 & zval <= 2.58 ~ "Moderate",
                                                    zval >= 2.58 & zval <= 3.29 ~ "Strong",
                                                    zval >= 3.29 ~ "Very strong"))


rep.dist.psy <- ggplot(data = rep_psy, aes(x = zval, y = replicate)) +
  geom_line(linetype="solid", color="black", linewidth = 0.5) +
  geom_ribbon(data = filter(rep_psy, zval >= 1.96 & zval <= 2.58), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.2) +
  geom_ribbon(data = filter(rep_psy, zval >= 2.58 & zval <= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.4) +
  geom_ribbon(data = filter(rep_psy, zval >= 3.29), aes(zval, ymax=replicate, ymin=0), fill="#E6AB02", alpha=0.5) + 
  geom_text(data = data.frame(x = c(2.27, 2.935, 4.645), 
                              label = c("Modest", "Strong", "Very Strong")),
            aes(x = x, y = 0.02, label = label), 
            vjust = 0, size = 3, color = "black", alpha = 0.7) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2),
                     minor_breaks=seq(0,1,0.05),expand = expansion(mult = c(0, 0.01)), labels = scales::percent_format(accuracy=1)) +
  scale_x_continuous(breaks = c(1.96,3,4,5,6), expand = expansion(mult = c(0.01, 0.01))) +
  ylab("Replicability") + xlab(expression(paste("Statistical evidence"~italic()))) +
  labs(colour = NULL, title = "Psychology") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        #axis.text.x = element_blank(),
        #axis.ticks.x = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))



png(filename = "figure1.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
rep.dist.med + rep.dist.eco + rep.dist.env +  rep.dist.psy + plot_layout(nrow = 2, ncol = 2) + plot_annotation(tag_levels = list(c('A', 'B', 'C', 'D'))) & theme(plot.tag = element_text(size = 14, face = "bold"))
dev.off()

```


## Modelling2
```{r}
# economics
res_eco <- rma(yi = mu_adj, sei = se_adj, data = dat_eco)

pb_eco <- rma(yi = mu_adj, sei = se_adj, mod = ~ se_adj, data = dat_eco)
sel <- selmodel(pb_eco, type="stepfun", steps=c(.025,.10,.50,1))


blup_eco <- blup(res_eco) %>% as.data.frame()
obs <- 1:nrow(dat_eco)
res_eco2 <- rma.mv(yi = mu_adj, V = se_adj, random = ~ 1 | obs , data = dat_eco, sparse = T) #https://stackoverflow.com/questions/66630647/how-to-calculate-combined-random-and-fixed-effect-blups-for-rma-mv-in-metafor
blup_eco2 <- ranef(res_eco2) %>% as.data.frame()
fixed_pred <- predict.rma(res_eco2) %>% data.frame()
ranef_preds <- ranef(res_eco2) %>% data.frame()



dat_eco$blup <- blup_eco$pred
dat_eco$snr <- dat_eco$blup / dat_eco$se_adj
mix.df_eco2 <- mix2(z=dat_eco$snr,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_eco2, here("Dat","mix.df_eco2.rds"))
#mix.df_eco2 <- readRDS(here("Dat","mix.df_eco2.rds"))
p_eco2 <- mix.df_eco2$p
m <- mix.df_eco2$m
sigma_eco2 <- mix.df_eco2$sigma


# environment
res_env <- rma(yi = mu_adj, sei = se_adj, data = dat_env)
blup_env <- blup(res_env) %>% as.data.frame()
dat_env$blup <- blup_env$pred
dat_env$snr <- dat_env$blup / dat_env$se_adj
mix.df_env2 <- mix2(z=dat_env$snr,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_env2, here("Dat","mix.df_env2.rds"))
#mix.df_env2 <- readRDS(here("Dat","mix.df_env2.rds"))
p_env2 <- mix.df_env2$p
m <- mix.df_env2$m
sigma_env2 <- mix.df_env2$sigma

# medicine
res_med <- rma(yi = mu_adj, sei = se_adj, data = dat_med)
blup_med <- blup(res_med) %>% as.data.frame()
dat_med$blup <- blup_med$pred
dat_med$snr <- dat_med$blup / dat_med$se_adj
mix.df_med2 <- mix2(z=dat_med$snr,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_med2, here("Dat","mix.df_med2.rds"))
#mix.df_med2 <- readRDS(here("Dat","mix.df_med2.rds"))
p_med2 <- mix.df_med2$p
m <- mix.df_med2$m
sigma_med2 <- mix.df_med2$sigma

# psychology
res_psy <- rma(yi = mu_adj, sei = se_adj, data = dat_psy)
blup_psy <- blup(res_psy) %>% as.data.frame()
dat_psy$blup <- blup_psy$pred
dat_psy$snr <- dat_psy$blup / dat_psy$se_adj
mix.df_psy2 <- mix2(z=dat_psy$snr,k=4,c1=0,c2=10,weights=1)
#saveRDS(mix.df_psy2, here("Dat","mix.df_psy2.rds"))
#mix.df_psy2 <- readRDS(here("Dat","mix.df_psy2.rds"))
p_psy2 <- mix.df_psy2$p
m <- mix.df_psy2$m
sigma_psy2 <- mix.df_psy2$sigma
```

## Estimate2

```{r}
# economics
snr_eco2=rmix(10^7,p=p_eco2,m=m,s=sqrt(sigma_eco2^2))
# power
power_eco2=pnorm(-1.96,snr_eco2,1) + 1 - pnorm(1.96,snr_eco2,1)
# replication
z.orig_eco2=snr_eco2 + rnorm(10^7) # original
z.repl_eco2 = snr_eco2 + rnorm(10^7) # replication
replicate_eco2=(z.orig_eco2 * z.repl_eco2 > 0) & (abs(z.repl_eco2) > 1.96)
mean(replicate_eco2)  #   0.4197378                # unconditional probability of replication
mean(replicate_eco2[abs(z.orig_eco2)>1.96]) # 0.774006 # conditional probability of replication given |z|>1.96

# environment
snr_env2=rmix(10^7,p=p_env2,m=m,s=sqrt(sigma_env2^2))
# power
power_env2=pnorm(-1.96,snr_env2,1) + 1 - pnorm(1.96,snr_env2,1)
# replication
z.orig_env2=snr_env2 + rnorm(10^7) # original
z.repl_env2 = snr_env2 + rnorm(10^7) # replication
replicate_env2=(z.orig_env2 * z.repl_env2 > 0) & (abs(z.repl_env2) > 1.96)
mean(replicate_env2)  #   0.4197378                # unconditional probability of replication
mean(replicate_env2[abs(z.orig_env2)>1.96]) # 0.774006 # conditional probability of replication given |z|>1.96

# psychology
snr_psy2=rmix(10^7,p=p_psy2,m=m,s=sqrt(sigma_psy2^2))
# power
power_psy2=pnorm(-1.96,snr_psy2,1) + 1 - pnorm(1.96,snr_psy2,1)
# replication
z.orig_psy2=snr_psy2 + rnorm(10^7) # original
z.repl_psy2 = snr_psy2 + rnorm(10^7) # replication
replicate_psy2=(z.orig_psy2 * z.repl_psy2 > 0) & (abs(z.repl_psy2) > 1.96)
mean(replicate_psy2)  #   0.4197378                # unconditional probability of replication
mean(replicate_psy2[abs(z.orig_psy2)>1.96]) # 0.774006 # conditional probability of replication given |z|>1.96

```

We can also compute the conditional probability of "successful replication" given the absolute value of the $z$-statistic of the original study. The symmetry of the distribution of the $z$-statistic implies that the conditional probability of "successful replication" given $|Z|=z$ is equal to the conditional probability given $Z=z$.

```{r, echo=TRUE, warning=FALSE}
replicate2=sapply(dat_eco$z_adj,replcalc,p=p_eco,m=m,s=sqrt(sigma_eco^2-1))
pval=c(0.1,0.05,0.01,0.001,0.0001)
zval=qnorm(1 - pval/2)
sapply(zval,replcalc,p=p_eco,m=m,s=sqrt(sigma_eco^2-1))
```

# Figure

```{r}
dat_df <- data.frame(discipline = c("Economics", "Environment", "Medicine", "Psychology"),
                     pwr_unadj = c(summary(dat_eco$pwr_unadj)[3], summary(dat_env$pwr_unadj)[3], summary(dat_med$pwr_unadj)[3], summary(dat_psy$pwr_unadj)[3]),
                     pwr_adj = c(summary(dat_eco$pwr_adj)[3], summary(dat_env$pwr_adj)[3], summary(dat_med$pwr_adj)[3], summary(dat_psy$pwr_adj)[3]),
                     M_unadj = c(summary(dat_eco$M_unadj)[3], summary(dat_env$M_unadj)[3], summary(dat_med$M_unadj)[3], summary(dat_psy$M_unadj)[3]),
                     M_adj = c(summary(dat_eco$M_adj)[3], summary(dat_env$M_adj)[3], summary(dat_med$M_adj)[3], summary(dat_psy$M_adj)[3]),
                     S_unadj = c(summary(dat_eco$S_unadj)[3], summary(dat_env$S_unadj)[3], summary(dat_med$S_unadj)[3], summary(dat_psy$S_unadj)[3]),
                     S_adj = c(summary(dat_eco$S_adj)[3], summary(dat_env$S_adj)[3], summary(dat_med$S_adj)[3], summary(dat_psy$S_adj)[3]),
                     rep_weak = c(rep_eco$replicate[2], rep_env$replicate[2], rep_med$replicate[2], rep_psy$replicate[2]),
                     rep_moderate = c(rep_eco$replicate[3], rep_env$replicate[3], rep_med$replicate[3], rep_psy$replicate[3])
                     )

dat_df <- dat_df %>% mutate(pwr_unadj = pwr_unadj * 100,
                            pwr_adj = pwr_adj * 100,
                            S_unadj = S_unadj * 100,
                            S_adj = S_adj * 100,
                            rep_weak = rep_weak * 100,
                            rep_moderate = rep_moderate *100)



# fig
## power 1
plot_pwr1 <- ggplot(dat_df, aes(x = reorder(discipline, pwr_unadj), y = pwr_unadj)) +
  geom_segment(aes(xend = reorder(discipline, pwr_unadj), yend = 0), color = "grey") +
  geom_point(color = "#0072B2", size = 6) +  
  coord_flip() +  
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(color = "grey", size = 0.2), 
    panel.grid.minor.y = element_line(color = "grey", size = 0.1),  
    axis.text = element_text(size = 10),  
    axis.title = element_text(size = 12),  
    plot.title = element_text(size = 14, hjust = 0.5),  # Center plot title
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    legend.position = "none"
  ) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "Discipline", y = "Power") +  
  ggtitle("Power by discipline (before publication bias)")

## power2
plot_pwr2 <- ggplot(dat_df, aes(x = reorder(discipline, pwr_adj), y = pwr_adj)) +
  geom_segment(aes(xend = reorder(discipline, pwr_adj), yend = 0), color = "grey") +
  geom_point(color = "#0072B2", size = 6) +  
  coord_flip() +  
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(color = "grey", size = 0.2), 
    panel.grid.minor.y = element_line(color = "grey", size = 0.1),  
    axis.text = element_text(size = 10),  
    axis.title = element_text(size = 12),  
    plot.title = element_text(size = 14, hjust = 0.5),  # Center plot title
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    legend.position = "none"
  ) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(x = "Discipline", y = "Power") +  
  ggtitle("Power by discipline (after publication bias)")

## M1
plot_M1 <- ggplot(dat_df, aes(x = reorder(discipline, M_unadj), y = M_unadj)) +
  geom_segment(aes(xend = reorder(discipline, M_unadj), yend = 0), color = "grey") +
  geom_point(color = "#0072B2", size = 6) +  
  coord_flip() +  
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(color = "grey", size = 0.2), 
    panel.grid.minor.y = element_line(color = "grey", size = 0.1),  
    axis.text = element_text(size = 10),  
    axis.title = element_text(size = 12),  
    plot.title = element_text(size = 14, hjust = 0.5),  # Center plot title
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    legend.position = "none"
  ) +
  scale_y_continuous(limits = c(0, 4)) +
  labs(x = "Discipline", y = "Magnitude error") +  
  ggtitle("M error by discipline (before publication bias)")

## M2
plot_M2 <- ggplot(dat_df, aes(x = reorder(discipline, M_adj), y = M_adj)) +
  geom_segment(aes(xend = reorder(discipline, M_adj), yend = 0), color = "grey") +
  geom_point(color = "#0072B2", size = 6) +  
  coord_flip() +  
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(color = "grey", size = 0.2), 
    panel.grid.minor.y = element_line(color = "grey", size = 0.1),  
    axis.text = element_text(size = 10),  
    axis.title = element_text(size = 12),  
    plot.title = element_text(size = 14, hjust = 0.5),  # Center plot title
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    legend.position = "none"
  ) +
  scale_y_continuous(limits = c(0, 4)) +
  labs(x = "Discipline", y = "Magnitude error") +  
  ggtitle("M error by discipline (after publication bias)")

# replication weak
plot_repWeak <- ggplot(dat_df, aes(x = reorder(discipline, rep_weak), y = rep_weak)) +
  geom_segment(aes(xend = reorder(discipline, rep_weak), yend = 0), color = "grey") +
  geom_point(color = "#0072B2", size = 6) +  
  coord_flip() +  
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(color = "grey", size = 0.2), 
    panel.grid.minor.y = element_line(color = "grey", size = 0.1),  
    axis.text = element_text(size = 10),  
    axis.title = element_text(size = 12),  
    plot.title = element_text(size = 14, hjust = 0.5),  # Center plot title
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    legend.position = "none"
  ) +
  scale_y_continuous(limits = c(0, 60)) +
  labs(x = "Discipline", y = "Replicability") +  
  ggtitle("Replicability by discipline (p = 0.05)")


# replication moderate
plot_repModerate <- ggplot(dat_df, aes(x = reorder(discipline, rep_moderate), y = rep_moderate)) +
  geom_segment(aes(xend = reorder(discipline, rep_moderate), yend = 0), color = "grey") +
  geom_point(color = "#0072B2", size = 6) +  
  coord_flip() +  
  theme_bw() +
  theme(
    panel.grid.major.y = element_line(color = "grey", size = 0.2), 
    panel.grid.minor.y = element_line(color = "grey", size = 0.1),  
    axis.text = element_text(size = 10),  
    axis.title = element_text(size = 12),  
    plot.title = element_text(size = 14, hjust = 0.5),  # Center plot title
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    legend.position = "none"
  ) +
  scale_y_continuous(limits = c(0, 60)) +
  labs(x = "Discipline", y = "Replicability") +  
  ggtitle("Replicability by discipline (p = 0.01)")

png(filename = "plot_error.png", width = 10, height = 10, units = "in", type = "windows", res = 400)
plot_pwr1 + plot_pwr2 + plot_M1 + plot_M2 + plot_repWeak + plot_repModerate + plot_layout(ncol = 2, nrow = 3) + plot_annotation(tag_levels = "A") & theme(plot.tag = element_text(size = 20, face = "bold"))

```



# Prior odds

https://github.com/cran/zcurve

https://bioconductor.org/packages/release/bioc/html/swfdr.html

```{r}
# overall
res <- zcurve(z = dat$z_adj, method = "EM", bootstrap = F)
summary(res, all = TRUE)
calcRodds(0.252, 0.12368) # 0.545449
calcRodds(0.252, dat$pwr_adj) %>% summary()

# economics
res_eco <- zcurve(z = dat_eco$z_adj, method = "EM", bootstrap = F)
summary(res_eco, all = TRUE)
calcRodds(0.056, 0.3932) # 0.6818917
dat_eco$R <- calcRodds(0.056, dat_eco$pwr_adj)

# environment
res_env <- zcurve(z = dat_env$z_adj, method = "EM", bootstrap = F)
summary(res_env, all = TRUE)
calcRodds(0.226, 0.52470) # 0.2460545
dat_env$R <- calcRodds(0.226, dat_env$pwr_adj)


# medicine
res_med <- zcurve(z = dat_med$z_adj, method = "EM", bootstrap = F)
summary(res_med, all = TRUE)
calcRodds(0.256, 0.11029) # 0.5685097
dat_med$R <- calcRodds(0.256, dat_med$pwr_adj)

# psychology
res_psy <- zcurve(z = dat_psy$z_adj, method = "EM", bootstrap = F)
summary(res_psy, all = TRUE)
calcRodds(0.251, 0.4789) # 0.2375457
dat_psy$R <- calcRodds(0.251, dat_psy$pwr_adj)
```

# Figure2 - Prior odds
```{r}
# figure
dat$R <- c(dat_eco$R, dat_env$R, dat_med$R, dat_psy$R)
df <- dat %>% select(id, discipline, R)
df$discipline <- as.factor(df$discipline)
df$discipline <- factor(df$discipline, levels = c("environmental", "psychology", "economics", "medicine"))

p_R <- ggplot(df, aes(x = R, y = discipline, fill = discipline)) +
  geom_density_ridges(color = "white", alpha = 0.5,
                      rel_min_height = 0.002,
                      scale = 1,
                      quantile_lines = TRUE) +
  #viridis::scale_fill_viridis(option = "viridis", discrete = T) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2),
                     minor_breaks=seq(0,1,0.05),expand = expansion(mult = c(0, 0.015)), labels = scales::percent_format(accuracy=1)) +
  scale_y_discrete(labels = c("Environment", "Psychology", "Economics", "Medicine"), expand = expansion(mult = c(0.01, 0.25))) +
  guides(fill = "none") +
  labs(x = "Pre-study probability", y = "") +
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        axis.title.y = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))
```

# Figure2 - Power
```{r}
# figure
df <- dat %>% select(id, discipline, pwr_adj)
df$discipline <- as.factor(df$discipline)
df$discipline <- factor(df$discipline, levels = c("environmental", "psychology", "economics", "medicine"))

p_pwr <- ggplot(df, aes(x = pwr_adj, y = discipline, fill = discipline)) +
  geom_density_ridges(color = "white", alpha = 0.5,
                      rel_min_height = 0.002,
                      scale = 1,
                      quantile_lines = TRUE) +
  #viridis::scale_fill_viridis(option = "viridis", discrete = T) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, by = 0.2),
                     minor_breaks=seq(0,1,0.05),expand = expansion(mult = c(0, 0.015)), labels = scales::percent_format(accuracy=1)) +
  scale_y_discrete(labels = c("Environment", "Psychology", "Economics", "Medicine"), expand = expansion(mult = c(0.01, 0.25))) +
  guides(fill = "none") +
  labs(x = "Statistical power", y = "") +
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        axis.title.y = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))
```


# Figure2 - M

```{r}
# figure
df <- dat %>% select(id, discipline, M_adj)
df$discipline <- as.factor(df$discipline)
df$discipline <- factor(df$discipline, levels = c("environmental", "psychology", "economics", "medicine"))

p_M <- ggplot(filter(df,M_adj<=4), aes(x = M_adj, y = discipline, fill = discipline)) +
  geom_density_ridges(color = "white", alpha = 0.5, stat = "binline", bins = 20, scale = 0.95, draw_baseline = FALSE) +
  scale_x_continuous(limits = c(1, 4), breaks = seq(1, 4, by = 0.5),
                     minor_breaks=seq(1,4,0.1),expand = expansion(mult = c(0, 0.015))) +
  scale_y_discrete(labels = c("Environment", "Psychology", "Economics", "Medicine"), expand = expansion(mult = c(0.01, 0.25))) +
  guides(fill = "none") +
  labs(x = "Magnitude error", y = "") +
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        axis.title.y = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))
```

# Figure2 - S

```{r}
# figure
df <- dat %>% select(id, discipline, S_adj)
df$discipline <- as.factor(df$discipline)
df$discipline <- factor(df$discipline, levels = c("environmental", "psychology", "economics", "medicine"))

p_S <- ggplot(filter(df, S_adj<=0.1), aes(x = S_adj, y = discipline, fill = discipline)) +
  geom_density_ridges(color = "white", alpha = 0.5, stat = "binline", bins = 20, scale = 0.85, draw_baseline = FALSE) +
  scale_x_continuous(limits = c(0, 0.1), breaks = seq(0, 0.1, by = 0.01),
                     minor_breaks=seq(0,0.1,0.005),expand = expansion(mult = c(0, 0.015)), labels = scales::percent_format(accuracy=1)) +
  scale_y_discrete(labels = c("Environment", "Psychology", "Economics", "Medicine"), expand = expansion(mult = c(0.01, 0.25))) +
  guides(fill = "none") +
  labs(x = "Sign error", y = "") +
  theme_bw() + 
  theme(axis.title = element_text(size = 12),
        axis.title.y = element_blank(),
        panel.grid.major = element_line(color = "grey", linetype = "dotted"),
        panel.grid.minor = element_line(color = "black", linetype = "dotted"))


# layout
png(filename = "figure2.png", width = 5, height = 10, units = "in", type = "windows", res = 400)
p_R + p_pwr + p_M + p_S + plot_layout(ncol = 1, nrow = 4) + plot_annotation(tag_levels = "A") & theme(plot.tag = element_text(size = 14, face = "bold"))

```


# Overestimation

https://osf.io/842hr

```{r}
# overall
mean( (dat$z_unadj / mean(dat$z_adj)) ) # 1.877645
# economics
mean( (dat_eco$z_unadj / mean(dat_eco$z_adj)) ) # 4.126645
# environment
mean( (dat_env$z_unadj / mean(dat_env$z_adj)) ) # 1.966678
# medicine
mean( (dat_med$z_unadj / mean(dat_med$z_adj)) ) # 1.857167
# psychology
mean( (dat_psy$z_unadj / mean(dat_psy$z_adj)) ) # 1.94695
```



# ES benchmark

```{r}
## folded mean
folded_es <-function(mean, variance){ # the sampling variance of magnitude   
  mu <- mean
  sigma <- sqrt(variance)
  fold_mu <- sigma*sqrt(2/pi)*exp((-mu^2)/(2*sigma^2)) + mu*(1 - 2*pnorm(-mu/sigma))
  fold_mu
}
## folded variance
folded_var <- function(mean, variance){ # the sampling variance of magnitude   
  mu <- mean
  sigma <- sqrt(variance)
  fold_mu <- sigma*sqrt(2/pi)*exp((-mu^2)/(2*sigma^2)) + mu*(1 - 2*pnorm(-mu/sigma))
  fold_se <- sqrt(mu^2 + sigma^2 - fold_mu^2)
  # adding se to make bigger mean
  fold_v <- fold_se^2
  fold_v
}

df <- dat
df <- df %>% mutate(folded_mu_adj = folded_es(mu_adj,I(se_adj^2)),
                    folded_var_adj = folded_var(mu_adj,I(se_adj^2)))


df_eco <- df %>% filter(discipline == "economics")
df_env <- df %>% filter(discipline == "environmental")
df_med <- df %>% filter(discipline == "medicine")
df_psy <- df %>% filter(discipline == "psychology")

# RE
res_med <- rma.mv(yi = folded_mu_adj, V = folded_var_adj, random = ~ 1 | id, method = "REML", sparse = T, data = df_med, verbose = T)

```

